<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login - Tech Log</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f8fafc;
    }
    .auth-card {
      width: 100%;
      max-width: 400px;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .auth-header {
      background-color: #1e293b;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    .auth-body {
      padding: 1.5rem;
    }
    .error-message {
      margin-top: 1rem;
      padding: 0.75rem;
      background-color: #fee2e2;
      color: #b91c1c;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      display: none;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-card">
      <div class="auth-header">
        <h1 class="text-xl font-bold">Tech Log</h1>
      </div>

      <div class="auth-body">
        <div id="error-message" class="error-message"></div>

        <div class="mt-6">
          <button id="google-signin"
                  class="w-full py-3 px-4 border border-slate-300 rounded-md flex items-center justify-center gap-2 hover:bg-slate-50 transition-colors">
            <!-- Google SVG -->
            <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
              <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
              <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
              <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
              <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
            </svg>
            <span class="text-sm font-medium text-slate-700">Sign in with Google</span>
          </button>
        </div>

        <div id="admin-login-form" class="hidden mt-4 space-y-4">
          <div>
            <label for="username" class="sr-only">Username</label>
            <input type="text" id="username" placeholder="Username"
                   class="w-full px-4 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label for="password" class="sr-only">Password</label>
            <input type="password" id="password" placeholder="Password"
                   class="w-full px-4 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <button id="admin-signin-btn"
                  class="w-full py-2 px-4 bg-slate-800 text-white rounded-md hover:bg-slate-900 transition-colors">
            Sign In
          </button>
        </div>

        <div class="mt-6 text-center">
          <button id="show-admin-login-btn" class="text-sm text-blue-600 hover:underline">Admin Login</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import {
      getAuth,
      signInWithRedirect,
      getRedirectResult,
      GoogleAuthProvider,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      setPersistence,
      browserLocalPersistence
    } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
    import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

    // --- FIREBASE CONFIG (replace values with your project's values if different) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAcahdEVwVPQc5J5ejAvFIAP7zu5ciiOqc",
      authDomain: "kajanaudaynotes.firebaseapp.com",
      projectId: "kajanaudaynotes",
      // regional database URL — use the asia-southeast1 regional URL to avoid warnings
      databaseURL: "https://kajanaudaynotes-default-rtdb.asia-southeast1.firebasedatabase.app",
      storageBucket: "kajanaudaynotes.firebasestorage.app",
      messagingSenderId: "696311985600",
      appId: "1:696311985600:web:ceaf9f9fcaf30cabc5c425",
      measurementId: "G-Y9QK783LVC"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const firestoreDb = getFirestore(app);
    const realtimeDb = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    // lightweight debug logs (remove in production)
    console.log('origin:', location.origin);
    console.log('firebase app options:', app.options);

    // UI elements
    const googleSignin = document.getElementById('google-signin');
    const errorMessage = document.getElementById('error-message');
    const showAdminLoginBtn = document.getElementById('show-admin-login-btn');
    const adminLoginForm = document.getElementById('admin-login-form');
    const adminSigninBtn = document.getElementById('admin-signin-btn');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const googleSigninContainer = googleSignin.parentElement;

    // Admin email domain derived from authDomain so we produce the same firebase user emails used in your project
    const ADMIN_EMAIL_DOMAIN = firebaseConfig.authDomain || 'example.firebaseapp.com';

    // Role assignment and debug recording
    const INITIAL_ADMIN_EMAIL = "kajana.uday@gmail.com";
    let isAdminLoginAttempt = false;
    const loginDebugLogs = [];

    function logAndStore(message) {
      console.log(message);
      const timestamp = new Date().toLocaleTimeString();
      loginDebugLogs.push(`[${timestamp}] ${message}`);
    }

    // Persist session in local persistence
    setPersistence(auth, browserLocalPersistence).catch((err) => {
      console.warn('setPersistence error (non-fatal):', err);
    });

    // Handle redirect result (called on page load after provider redirects back)
    getRedirectResult(auth)
      .then((result) => {
        if (result && result.user) {
          console.log('Redirect sign-in result:', result.user.uid);
          // onAuthStateChanged will run and perform role assignment/redirect
        } else {
          console.log('No redirect sign-in result.');
        }
      })
      .catch((error) => {
        console.error('getRedirectResult error:', error);
        showError(`Authentication error: ${error.message || error.code}`);
      });

    // React to auth state changes (role lookup/assignment and redirect to application.html)
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;

      const userRoleRef = ref(realtimeDb, `userRoles/${user.uid}`);
      let userRole;

      try {
        logAndStore(`[Auth] Checking role for user: ${user.uid}`);
        const roleSnapshot = await get(userRoleRef);
        if (roleSnapshot.exists()) {
          userRole = roleSnapshot.val();
          logAndStore(`[Auth] Role found in database: '${userRole}'`);
        } else {
          logAndStore('[Auth] No role found in database. Assigning new role.');
          userRole = isAdminLoginAttempt ? 'admin' : 'reader';
          logAndStore(`[Auth] Login method was admin form: ${isAdminLoginAttempt}. Assigning role: '${userRole}'`);
          await set(userRoleRef, userRole);
          logAndStore('[Auth] New role saved to database.');
        }

        localStorage.setItem('userRole', userRole);
        logAndStore(`[Auth] Role '${userRole}' stored in localStorage. Redirecting to application...`);
        isAdminLoginAttempt = false;

        await logUserLogin(user, userRole);
        sessionStorage.setItem('loginDebugLogs', JSON.stringify(loginDebugLogs));

        // Redirect to main app page
        window.location.href = 'application.html';
      } catch (err) {
        console.error('Error during auth state handling:', err);
        showError('An internal error occurred. See console for details.');
      }
    });

    // Log user login in Firestore
    async function logUserLogin(user, userRole) {
      try {
        const userLogRef = doc(firestoreDb, "user_logs", user.uid);
        await setDoc(userLogRef, {
          email: user.email,
          displayName: user.displayName || '',
          lastLogin: serverTimestamp(),
          isAdmin: userRole === 'admin'
        }, { merge: true });

        const loginLogRef = doc(firestoreDb, "login_logs", `${user.uid}_${Date.now()}`);
        await setDoc(loginLogRef, {
          userId: user.uid,
          email: user.email,
          timestamp: serverTimestamp(),
          userAgent: navigator.userAgent,
          isAdmin: userRole === 'admin'
        });
      } catch (error) {
        console.error("Error logging user login:", error);
      }
    }

    // UI helpers
    function showError(msg) {
      errorMessage.style.display = 'block';
      errorMessage.textContent = msg;
      console.warn(msg);
    }

    function hideError() {
      errorMessage.style.display = 'none';
      errorMessage.textContent = '';
    }

    // Start redirect-based sign-in for Google
    googleSignin.addEventListener('click', async () => {
      hideError();
      try {
        googleProvider.setCustomParameters({ prompt: 'select_account' });
        await signInWithRedirect(auth, googleProvider);
        // The browser will navigate away to provider and come back — no further code here runs
      } catch (error) {
        console.error("Authentication error (redirect):", error);
        showError(getErrorMessage(error));
      }
    });

    // Admin login toggle
    showAdminLoginBtn.addEventListener('click', () => {
      googleSigninContainer.classList.add('hidden');
      adminLoginForm.classList.remove('hidden');
      showAdminLoginBtn.textContent = 'Back to User Login';
      hideError();

      // Toggle back handler
      showAdminLoginBtn.onclick = () => {
        googleSigninContainer.classList.remove('hidden');
        adminLoginForm.classList.add('hidden');
        showAdminLoginBtn.textContent = 'Admin Login';
        showAdminLoginBtn.onclick = null;
        showAdminLoginBtn.addEventListener('click', arguments.callee, { once: true });
      };
    }, { once: true });

    // Admin sign-in with email/password (constructs an internal email using the project's authDomain)
    adminSigninBtn.addEventListener('click', async () => {
      hideError();
      const username = usernameInput.value;
      const password = passwordInput.value;

      if (!username || !password) {
        showError('Please enter both username and password.');
        return;
      }

      // create an email using the project's authDomain so it matches supervised test accounts if you use this convention
      const emailForFirebase = `${username.trim()}@${ADMIN_EMAIL_DOMAIN}`;

      try {
        isAdminLoginAttempt = true;
        await signInWithEmailAndPassword(auth, emailForFirebase, password);
        // onAuthStateChanged will handle role assignment & redirect
      } catch (error) {
        console.error("Admin authentication error:", error);
        showError(getErrorMessage(error));
        isAdminLoginAttempt = false;
      }
    });

    // Friendly error mapping
    function getErrorMessage(error) {
      const code = error && error.code ? error.code : null;
      switch (code) {
        case 'auth/popup-closed-by-user':
          return 'Sign-in popup was closed before completing the sign in.';
        case 'auth/cancelled-popup-request':
          return 'The sign-in popup was cancelled.';
        case 'auth/popup-blocked':
          return 'Sign-in popup was blocked by the browser.';
        case 'auth/user-not-found':
        case 'auth/wrong-password':
        case 'auth/invalid-credential':
          return 'Invalid email or password. Please try again.';
        case 'auth/too-many-requests':
          return 'Access to this account has been temporarily disabled due to many failed login attempts. Try again later.';
        case 'auth/unauthorized-domain':
          return 'This domain is not authorized for OAuth operations. Add your domain to the Firebase console (Authentication → Authorized domains).';
        default:
          return (error && (error.message || error.code)) || 'An error occurred during sign in. Please try again.';
      }
    }
  </script>
</body>
</html>
